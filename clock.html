<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Часы</title>
    <!-- Font: Manrope -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;700;800&display=swap" rel="stylesheet">
    
    <!-- Meta Tags -->
    <meta property="og:title" content="Часы от Флуриона">
    <meta property="og:description" content="Просто часы с музыкой.">
    <meta property="og:image" content="https://flurion.qzz.io/images/clock.png">
    <meta property="og:url" content="https://flurion.qzz.io/clock">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Flurion">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Часы от Флуриона">
    <meta name="twitter:description" content="Просто часы с музыкой.">
    <meta name="twitter:image" content="https://flurion.qzz.io/images/clock.png">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <style>
        /* --- Theming System --- */
        :root {
            /* Dimensions */
            --width-hour: clamp(4px, 1.5vmin, 8px);
            --width-min: clamp(2px, 1vmin, 4px);
            --width-sec: 2px;

            /* Light Theme (Default) */
            --bg-color: #dbe4eb;
            --bg-gradient: radial-gradient(circle at center, rgba(255,255,255,0.4) 0%, rgba(0,0,0,0.05) 100%);
            
            /* Red Colors for Light Mode */
            --clock-main: #a61c31;      /* Deep Crimson */
            --clock-tick: #a61c31;      
            
            --clock-shadow: 
                20px 20px 60px rgba(0,0,0,0.05), 
                -20px -20px 60px rgba(255,255,255,0.5);
            
            --overlay-bg: rgba(166, 28, 49, 0.95);
        }

        /* Dark Theme Override */
        [data-theme="dark"] {
            --bg-color: #161625;        
            --bg-gradient: radial-gradient(circle at center, rgba(40,40,60,0.4) 0%, rgba(0,0,0,0.2) 100%);
            
            /* Red Colors for Dark Mode */
            --clock-main: #ff6b6b;      /* Bright Salmon/Red */
            --clock-tick: #ff6b6b;      
            
            --clock-shadow: 
                15px 15px 35px rgba(0,0,0,0.5), 
                -15px -15px 35px rgba(255,255,255,0.05); 
            
            --overlay-bg: rgba(40, 10, 10, 0.95);
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            font-family: 'Manrope', sans-serif;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        #audio-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-bg);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: opacity 0.5s;
        }

        .clock-container {
            position: relative;
            width: min(90vw, 500px);
            height: min(90vw, 500px);
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            box-shadow: var(--clock-shadow);
            transition: box-shadow 0.5s ease;
        }

        .clock-face {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        .clock-tick {
            stroke: var(--clock-tick);
            transition: stroke 0.5s ease;
        }
        
        .digital-display {
            position: absolute;
            top: 65%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(2rem, 11vmin, 3.5rem); 
            color: var(--clock-main);
            letter-spacing: 1px;
            z-index: 2;
            opacity: 0.9;
            line-height: 1;
            
            /* Grid Layout */
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            column-gap: 0.3ch; 
            
            align-items: center;
            justify-items: center;
            transition: color 0.5s ease;
        }

        /* Font Weights */
        #d-hour, #d-min {
            font-weight: 700; /* Bold */
        }
        #d-sec {
            font-weight: 300; /* Thin */
            opacity: 0.8; 
        }

        .time-part {
            text-align: center;
            min-width: 2ch;
        }

        .hands-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .hand {
            position: absolute;
            top: 50%;
            left: 50%;
            background-color: var(--clock-main);
            border-radius: 4px;
            transition: background-color 0.5s ease;
        }

        .hand.hour {
            width: var(--width-hour);
            height: 35%;
            transform-origin: 50% 85%;
        }

        .hand.minute {
            width: var(--width-min);
            height: 55%;
            transform-origin: 50% 81.8%; 
        }

        .hand.second {
            width: var(--width-sec);
            height: 60%;
            background-color: var(--clock-main);
            transform-origin: 50% 80%;
        }
        
    </style>
</head>
<body>

    <div id="audio-overlay">Нажмите, чтобы включить звук...<br><span style="font-size: 0.8em; opacity: 0.7">(Syncing time...)</span></div>
    
    <audio id="clock-audio" src="/audio/clock.mp3" preload="auto" loop></audio>

    <div class="clock-container">
        <svg class="clock-face" viewBox="0 0 100 100"></svg>

        <div class="digital-display" id="digital-clock">
            <div class="time-part" id="d-hour">00</div>
            <div class="time-part" id="d-min">00</div>
            <div class="time-part" id="d-sec">00</div>
        </div>

        <div class="hands-container">
            <div class="hand hour" id="hand-hour"></div>
            <div class="hand minute" id="hand-min"></div>
            <div class="hand second" id="hand-sec"></div>
        </div>
    </div>

    <script>
        // --- Time Sync Logic ---
        let timeOffset = 0; // Difference between Server Time and System Time
        const overlayText = document.querySelector('#audio-overlay span');

        async function syncServerTime() {
            try {
                const start = Date.now();
                const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                const end = Date.now();
                
                // 1. Get accurate Server Time
                const serverTime = new Date(data.utc_datetime).getTime();
                
                // 2. Calculate Network Latency (Round Trip Time / 2)
                const latency = (end - start) / 2;
                
                // 3. Estimated "True Now" = Server Time + Latency
                const trueNow = serverTime + latency;
                
                // 4. Calculate Offset
                timeOffset = trueNow - end;
                
                console.log(`Time Synced. Offset: ${timeOffset}ms. Latency: ${latency}ms`);
                if(overlayText) overlayText.textContent = "(Time Synced)";
                
            } catch (error) {
                console.warn('Time sync failed, falling back to system time.', error);
                if(overlayText) overlayText.textContent = "(Using System Time)";
            }
        }

        // --- Theme Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const manualTheme = urlParams.get('theme'); // 'dark' or 'light'
        let currentTheme = 'light';

        function updateTheme(hour) {
            if (manualTheme === 'dark') {
                setTheme('dark');
                return;
            }
            if (manualTheme === 'light') {
                setTheme('light');
                return;
            }

            // Auto: Dark between 19:00 and 06:59
            if (hour >= 19 || hour < 7) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        }

        function setTheme(theme) {
            if (currentTheme === theme) return;
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
        }

        // --- Audio Logic ---
        const audio = document.getElementById('clock-audio');
        const overlay = document.getElementById('audio-overlay');
        let audioEnabled = false;

        overlay.addEventListener('click', () => {
            audioEnabled = true;
            syncAudio();
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 500);
        });

        function syncAudio() {
            if (!audioEnabled) return;
            
            // Use the Corrected Time
            const now = new Date(Date.now() + timeOffset);
            const s = now.getSeconds();
            const ms = now.getMilliseconds();
            
            const targetTime = s + (ms / 1000);
            if (Math.abs(audio.currentTime - targetTime) > 0.5) {
                audio.currentTime = targetTime;
            }
            if (audio.paused) audio.play().catch(e => console.error("Playback failed", e));
        }

        // --- Clock Logic ---
        function initClockFace() {
            const svg = document.querySelector('.clock-face');
            const center = 50;
            const radius = 45;
            
            for (let i = 0; i < 60; i++) {
                const isHour = i % 5 === 0;
                
                // Tick Logic: Show ticks only after 45 secs/mins
                if (!isHour && i <= 45) continue;

                const angle = (i * 6) * (Math.PI / 180); 
                let length = isHour ? 4 : 1.5; 
                let strokeWidth = isHour ? 1.5 : 0.5;

                const x1 = center + Math.sin(angle) * (radius);
                const y1 = center - Math.cos(angle) * (radius);
                const x2 = center + Math.sin(angle) * (radius - length);
                const y2 = center - Math.cos(angle) * (radius - length);

                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x1);
                line.setAttribute("y1", y1);
                line.setAttribute("x2", x2);
                line.setAttribute("y2", y2);
                line.setAttribute("class", "clock-tick"); 
                line.setAttribute("stroke-width", strokeWidth);
                line.setAttribute("stroke-linecap", "round");
                
                svg.appendChild(line);
            }
        }

        let previousSecond = -1;

        function updateClock() {
            // CRITICAL CHANGE: Use system time + offset
            const now = new Date(Date.now() + timeOffset);
            
            const h = now.getHours();
            const m = now.getMinutes();
            const s = now.getSeconds();

            updateTheme(h);

            // Digital Update
            const pad = (num) => String(num).padStart(2, '0');
            document.getElementById('d-hour').textContent = pad(h);
            document.getElementById('d-min').textContent = pad(m);
            document.getElementById('d-sec').textContent = pad(s);

            // Audio Check
            if (s !== previousSecond) {
                if (audioEnabled) syncAudio();
                previousSecond = s;
            }

            // Analog Movement
            setHandTransform('hand-sec', s * 6, 50, 80);
            setHandTransform('hand-min', m * 6, 50, 81.8);

            const hourDeg = ((h % 12) * 30) + (m * 0.5);
            setHandTransform('hand-hour', hourDeg, 50, 85);
            
            requestAnimationFrame(updateClock);
        }

        function setHandTransform(elementId, deg, pivotX, pivotY) {
            const el = document.getElementById(elementId);
            el.style.transform = `translate(-${pivotX}%, -${pivotY}%) rotate(${deg}deg)`;
        }

        // Initialize
        initClockFace();
        syncServerTime(); // Start the fetch immediately
        requestAnimationFrame(updateClock);
    </script>
</body>
</html>